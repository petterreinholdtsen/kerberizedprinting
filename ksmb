#!/bin/sh
# To be put in the /usr/libexec/cups/backend/ 
# Allow Samba kerberized printing from MacOSX.

# 
# A.Martins-Melo janvier 2005 
# v1.0b2 signal USR1 send to the user_kprintd process
#

# For security reason, temporary file must not be readeable
#by other user
umask 0077

if [ ${#*} = 0 ]; then
    echo 'network ksmb "Unknown" "Windows Printer via SAMBA with kerberos support v1.0"'
    exit 0
fi

if [ root != "$(whoami)" ]; then
    echo "error: backend require root privileges"
    exit 1
fi

# binaries path
cat=/bin/cat
rm=/bin/rm
mv=/bin/mv
chmod=/bin/chmod
chown=/bin/chown
#su=/usr/bin/su
#touch=/usr/bin/touch
mkdir=/bin/mkdir
sed=/bin/sed
awk=/usr/bin/awk
grep=/usr/bin/grep
echo=/bin/echo
kill=/bin/kill
ps=/bin/ps
# smbclient=/usr/bin/smbclient

# spool path
spooldir=/var/spool/samba/clientspool

# create the spool directory if not already existing
$mkdir -p $spooldir
$chmod og=x  $spooldir
# Make sure all users can access their spool directory
$chmod og=x  $spooldir/..

# Utilisateur
user=$2

# Extract Windows printer name and server
printer=`$echo $DEVICE_URI | $sed "s,k*smb://,,g"`
server=`$echo $printer | $sed "s,/.*$,,g"`
printer=`$echo $printer | $sed "s,.*/,,g"`

# temp file
# right only for the user
printdir=$spooldir/$user/$server/$printer
$mkdir -p $printdir
tempofile=$printdir/tempo.$$
printfile=$printdir/print.$$
> $tempofile
$chown -R $user $spooldir/$user

# put the spool generated by CUPS in the temp file
$cat - > $tempofile

# put the full temp file in the final print file
$mv $tempofile $printfile

# Find the ID of the user deamon
printpid=`ps -uxw -U $user  2>/dev/null | grep "[u]ser_kprintd" | awk '{print $2}'` > /dev/null 2>&1

# Send the signal to start the job !
$kill -USR1 $printpid

# Wait for the end of the printing process
while [ -f $printfile ]; do
 sleep 5
done

exit 0
